import Head from 'next/head';
import { memo, useEffect, useState, lazy, useCallback } from 'react';
import { CmsDataConfig } from './api/customCMS/interfaces';
import { StarterApp } from '../components/Layout/Spiners&Loaders/StarterApp';
import { getCMSData } from '../utils/providers/requests/homeCB';
import { HomeClientDataProps } from '../utils/dataConfigWorkflow.interfaces';
import { HomeBannerConfig } from './api/customCMS/interfaces';

const HomeBanner = lazy(() => import('../components/Mains/Banners/mainBanner/MainBanner'));

export default memo(function Home({ homeBanner }: HomeClientDataProps) {

    const [isLoading, setIsLoading] = useState<boolean>(true);
    const [initialStorageValue, setInitialStorageValue] = useState<boolean>(false);

    const storageValidator = useCallback(() => {
        const storedValue = window.sessionStorage.getItem('isLoading');
        if (storedValue !== null) {
            setIsLoading(storedValue === 'true');
        } else {
            setIsLoading(true);
        }
        setInitialStorageValue(true);
    }, []);

    useEffect(() => {
        storageValidator();
    }, [storageValidator]);

    useEffect(() => {
        function handlePageLoad() {
            if (sessionStorage.getItem('isLoading') === 'false') {
                console.log("Welcome to Cherced World")
            } else {
                const timerId = setTimeout(() => {
                    sessionStorage.setItem('isLoading', 'false');
                    setIsLoading(false);
                }, 4500);
                return () => {
                    clearTimeout(timerId);
                };
            }
        }

        handlePageLoad();

    }, []);

    return (
        <>
            <Head>
                <title>Create Next App</title>
                <meta name="description" content="Generated by create next app" />
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                <link rel="icon" href="/favicon.ico" />
            </Head>
            {initialStorageValue && isLoading && <StarterApp />}
            {!isLoading && (
                homeBanner ? <HomeBanner homeBanner={homeBanner} /> : null
            )}
        </>
    );
});

interface HomeServerDataProps {
    props: {
        homeBanner: HomeBannerConfig | null;
    }
}


export async function getServerSideProps(): Promise<HomeServerDataProps> {
    try {
        const cmsData: CmsDataConfig = await getCMSData();
        const homeBanner = cmsData.homeBanner;
        return {
            props: {
                homeBanner,
            },
        }
    } catch (error) {
        console.error("Error al obtener los datos del CMS:", error);
        return {
            props: {
                homeBanner: null,
            },
        };
    }
}